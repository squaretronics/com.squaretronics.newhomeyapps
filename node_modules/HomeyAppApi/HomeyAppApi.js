'use strict';

const https = require("https");
const Homey = require("homey");

const AppLimit = 14;
const newappspath = "/api/app?cache=true&fields=name&limit=" + AppLimit + "&order_by=created,desc&skip=0&title=New";
const updatedappspath = "/api/app?cache=true&fields=name,version&limit=" + AppLimit + "&order_by=updated,desc&skip=0&title=Recently+Updated";
const host = "apps.athom.com";

class HomeyAppApi{

    async retrieve(){
        let newApps = await this._makeHttpRequest(newappspath,'GET');
        let updates = await this._makeHttpRequest(updatedappspath,'GET');
        return {
            'new': JSON.parse(newApps.body),
            'updates': JSON.parse(updates.body)
        };
    }

    _makeHttpRequest(path,method){
        Homey.app.log('Connecting to '+path);
        return new Promise((resolve,reject)=>{
            const req  = https.get({
                host: host,
                path: path,
            },(res)=>{

                var body = '';
                res.on('data',(chunk)=>{
                    Homey.app.doLog("retrieve data");
                    body+=chunk;
                });
                res.on('end',()=>{
                    Homey.app.doLog("Done retrieval of data");
                    res.body = body;
                    resolve(res);
                });
            }).on('error',(err)=>{
                Homey.app.doLog("Error while connecting to "+this.host);
                Homey.app.doLog(err);
                reject(err);
            });
        });
    }
}

module.exports = HomeyAppApi;